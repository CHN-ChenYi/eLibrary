# 1 大程序简介

## 1.1 选题背景及意义

## 1.2 目标要求

## 1.3 术语说明

# 2 功能需求分析

# 3 程序开发设计

## 3.1 总体架构设计

## 3.2 功能模块设计

## 3.3 数据结构设计

## 3.4 源代码文件组织设计

## 3.5 函数设计描述

### model

### template

#### ui.c

为了叙述方便，这里简要讲述一下我们使用的模型。

当前的页面被分为三层：

1. 框架层：背景的色块，如顶部菜单栏的蓝底，登陆界面中间的灰色。
2. 元件层：标签、链接、图片、输入框、按钮这样的实际内容
3. 顶层：在本程序中，只用来处理顶部菜单的子菜单栏

每一层均使用一个链表维护所有元件。

在刷新屏幕的时候，先画框架，再画元件，最后画顶层，保证显示的顺序正确。同一层内保证元素互不重叠。

下文向某一层“插入”某元素，等价于说向那一层对应的链表插入某元素

##### CreateButton

* 函数原型

  ```c
  Button* CreateButton(Rect rect, char* caption, char* bg_color, double alpha,
                       FontColor font_color, int id)
  ```

* 功能描述：创建一个按钮，返回新创建的按钮元件的地址

* 参数描述：

  * rect    : 一个矩形，其大小由左右上下确定

  *  font_color : 一个enum类型，只有三种颜色

    * kRed  : 红色

    * kBlack : 黑色

    * kWhite : 白色

  * id     : 用来标记回调函数，当某元件被点击的时候，调用其id对应的回调函数

  * caption : 按钮上显示的文字

  * bg_color : 按钮的背景色，采用CSS样式的长度为6的串

  * alpha  : 按钮背景色的透明度

* 返回值描述：新创建的按钮元件的地址

* 重要局部变量定义：```Button* ret```

* 重要局部变量用途描述：暂存新生成的按钮元件

* 函数算法描述：无

##### CreateInputBox

* 函数原型

  ```c
  InputBox* CreateInputBox(Rect rect, char* str, int id, int is_terminal);
  ```

* 功能描述：创建一个输入框，并返回新创建的输入框元件的地址

* 参数描述：

  * rect: 同上 此处只需要输入左右边界和下边界位置即可，上边界会根据字体自动调整
  *  str: 初始字符串
  * id: 同上
  *  is_terminal : 底部的状态信息栏也是使用InputBox，但是不响应删除操作，颜色相反，因此需和一般的输入框区分，此处1表示是底部状态栏，0表示不是

* 返回值描述：新创建的输入框元件的地址

* 重要局部变量定义：`InputBox* ret`

* 重要局部变量用途描述：暂存新生成的输入框元件

* 函数算法描述：无

##### CreateLink

* 函数原型

  ```c
  Link* CreateLink(Rect rect, char* caption, FontColor font_color, int id);
  ```

* 功能描述：创建一个链接，并返回新创建的链接的地址

* 参数描述：

  * rect   : 此处只需要输入左下边界即可，上右边界会根据字串的长宽自动计算
  * caption : 链接的文字
  * 其余同上

* 返回值描述：新创建的链接的地址

* 重要局部变量定义：`Link* ret`

* 重要局部变量用途描述：暂存新生成的链接

* 函数算法描述：无

##### CreateLabel

- 函数原型

  ```c
  Label* CreateLabel(Rect rect, char* caption, FontColor font_color, int id);
  ```

- 功能描述：创建一个标签，并返回新创建的标签元件的地址

- 参数描述：

  - rect   : 此处只需要输入左下边界即可，上右边界会根据字串的长宽自动计算
  - caption : 标签的文字
  - 其余同上

- 返回值描述：新创建的标签元件的地址

- 重要局部变量定义：`Label* ret`

- 重要局部变量用途描述：暂存新生成的标签

- 函数算法描述：无

##### CreateFrame

- 函数原型

  ```c
  Frame* CreateFrame(Rect rect, char* color, double alpha);
  ```

- 功能描述：创建一个框架并返回指向新框架的指针

- 参数描述：

  - color : 一个CSS风格的6位字符串，表示框架的颜色
  - alpha : 框架透明度，0到1
  - 其余同上

- 返回值描述：指向新框架的指针

- 重要局部变量定义：`Frame* ret`

- 重要局部变量用途描述：暂存新生成的框架

- 函数算法描述：无

##### CreateImage

* 函数原型

  ```c
  CreateImage(Rect rect, LibImage ui_image, int id);
  ```

* 功能描述：创建一个图片元件，并返回一个指向新创建的图片元素的指针

* 参数描述：

  * rect   : 此处规定的是图片允许被占用的最大区域，当图片的长宽比恰好等于此区域的长宽比的时候，图片会刚好占到这片区域；否则将会同比缩放图片，使长宽中有一维贴合边界
  * ui_image : 图片本身

* 返回值描述：指向新创建的图片元素的指针

* 重要局部变量定义：`Image* ret`

* 重要局部变量用途描述：暂存新生成的图片元素

* 函数算法描述：无

##### InsertComp

- 函数原型

  ```c
  void InsertComp(void* component, TypeOfComp type);
  ```

- 功能描述：向当前画面插入分类为type的元素component

- 参数描述：

  - `component`是一个指向元件的指针，之所以是`void*`类型，是因为一共可能有5种，
  - `type`是一个类型，有以下几种类型：（注意没有`Frame`是因为`Frame`是会单独维护的）
    - `kButton`：按钮
    - `kInputBox`：输入框
    - `kLink`：链接
    - `kLabel`：标签
    - `kImage` ：图片

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 链表头部插入操作：申请插入元素的内存，将其`next`指针指向链表头的后一个元素，并将链表头的`next`指针指向该元素

##### InsertFrame

* 函数原型

  ```c
  void InsertFrame(void* component);
  ```

* 功能描述：向当前画面插入框架`component`

* 参数描述：`component`是一个`Frame*`，此处为了和之前代码统一使用了`void*`

* 返回值描述：无

* 重要局部变量定义：无

* 重要局部变量用途描述：无

* 函数算法描述：

  - 链表头部插入操作：申请插入元素的内存，将其`next`指针指向链表头的后一个元素，并将链表头的`next`指针指向该元素

##### InsertSurface

- 函数原型

  ```c
  void InsertSurface(void* component, TypeOfComp type);
  ```

- 功能描述：在表层插入分类为`type`的元件

- 参数描述：`component`是希望加入的元件，`type`是元件类型

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### InitFrame

- 函数原型

  ```c
  void InitFrame();
  ```

- 功能描述：初始化框架层，如果框架层不空，清空框架层后新建框架层

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 链表清空操作：从链表头开始遍历链表，一路清空链表元素，直到链表被清空为止

##### InitSurface

- 函数原型

  ```c
  void InitSurface();
  ```

- 功能描述：初始化顶层，如果顶层不空，清空顶层后新建顶层

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 链表清空操作：从链表头开始遍历链表，一路清空链表元素，直到链表被清空为止

##### InitComponents

- 函数原型

  ```c
  void InitComponents();
  ```

- 功能描述：初始化元件层，如果元件层不空，清空元件层后新建元件层

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 链表清空操作：从链表头开始遍历链表，一路清空链表元素，直到链表被清空为止

##### FlushScreen

- 函数原型

  ```c
  void FlushScreen(int x, int y);
  ```

- 功能描述：刷新屏幕

- 参数描述：

  - `x`：当前鼠标`x`坐标
  - `y`：当前鼠标`y`坐标

- 返回值描述：无
- 重要局部变量定义：无
- 重要局部变量用途描述：无
- 函数算法描述：无

##### InitializeUI

- 函数原型

  ```c
  void InitializeUI();
  ```

- 功能描述：初始化UI框架，包括

  - 初始化三层，
  - 设置字体
  - 设置字号
  - 注册回调函数

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### ColorConvert

- 函数原型

  ```c
  Color ColorConvert(char* color, double alpha);
  ```

- 功能描述：将CSS风格的颜色字符串加上透明度转化为wingdi使用的颜色格式

- 参数描述：

  - `color`：一个CSS格式的六位字符串
  - `alpha`：颜色的透明度

- 返回值描述：

  - `Color`结构体的一个变量，表示转化后的颜色，该结构体的内部为
    - `int R`：红色通道的值，范围`0 - 65535`，下同
    - `int G`：绿色通道的值
    - `int B`：蓝色通道的值
    - `int Alpha`：透明度通道的值

- 重要局部变量定义：

  - `C2D`数组：一个十六进制的字符对应的十进制的值，如果不合法则是0

- 重要局部变量用途描述：无

- 函数算法描述：遍历六位字符串，每两位计算出一个RGB值，乘上256转化为wingdi适用的颜色

##### DrawRectangle

- 函数原型

  ```c
  void DrawRectangle(Rect* rect);
  ```

- 功能描述：画一个矩形

- 参数描述：

  - `rect`是我们需要画的矩形，其内部为：
    - `left`：矩形的左边框x坐标
    - `right`：矩形的右边框x坐标
    - `top`：矩形的上边框y坐标
    - `bottom`：矩形的下边框y坐标

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：先将笔移动到左下角，按照顺时针顺序进行四次`DrawLine`

##### DrawFrame

- 函数原型

  ```c
  void DrawFrame(Frame* rect);
  ```

- 功能描述：绘制框架（实心矩形）

- 参数描述：

  - `rect`是一个`Frame*`，其内部为：
    - `Rect position`：标记该实心矩形的位置
    - `Color color`：颜色

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：调用wingdi中的`GradientFill`

##### DrawButton

- 函数原型

  ```c
  void DrawButton(Button* button, int mouse_x);
  ```

- 功能描述：画按钮

- 参数描述：

  - `button`：需要画的按钮
  - `mouse_x`：当前鼠标的位置，用来实现显示一个随着鼠标移动而改变的按钮

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### DrawOuter

- 函数原型

  ```c
  void DrawOuter(Rect* rect);
  ```

- 功能描述：画这个矩形的外边框

- 参数描述：

  - `rect`：要画的矩形

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：计算出比当前矩形靠外侧5px的矩形位置，然后绘制这个矩形

##### GetStringWidthN

- 函数原型

  ```c
  int GetStringWidthN (char* str, int left, int right)
  ```

- 功能描述：计算`str`串从`[left, right)`段画出来之后的长度（单位：像素）

- 参数描述：见功能描述

- 返回值描述：字符串长度，单位像素

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：先将`right`位替换成`'\0'`，然后调用库里面的`TextStringWidth(str + left)`，计算出结果后将`right`位替换回去

##### DrawTextStringN

- 函数原型

  ```c
  void DrawTextStringN (char* str, int left, int right);
  ```

- 功能描述：绘制`str`串的`[left, right)`位

- 参数描述：见功能描述

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：先将`right`位替换成`'\0'`，然后调用库里面的`DrawTextString(str + left)`，之后将`right`位替换回去

##### DrawContent

- 函数原型

  ```c
  void DrawContent(InputBox* input_box, int draw_cursor);
  ```

- 功能描述：绘制输入框的文本内容

- 参数描述：

  - `input_box`：等待绘制的输入框
  - `draw_cursor`：是否绘制光标，只有当当前焦点在这个输入框的时候才会绘画光标

- 返回值描述：无

- 重要局部变量定义：

  - `int inner_length`：输入框的内宽度，为输入框的总宽度减去输入框的
  - `int left_most = 0, right_most = 0`为打印字符串的左右界`[left_most, right_most)`

- 重要局部变量用途描述：见上

- 函数算法描述：

  - 首先判断，从输入框字符串的第一个字符到光标位置是否能够填满整个输入框的长度
    - 如果不能够填满，说明应该从第一个字符开始打印，枚举结束位置，找到最多能够打印多少字符然后输出
    - 如果能够填满，说明此时光标应该在输入框的最后，向前枚举显示字符串的开始位置，然后输出

##### DrawInputBox

- 函数原型

  ```c
  void DrawInputBox(InputBox* input_box, int draw_cursor);
  ```

- 功能描述：绘制输入框

- 参数描述：

  - `input_box`：待绘制的输入框
  - `draw_cursor`：是否绘制光标

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 查看当前`input_box`上是否有鼠标（通过查看其`status`字段）
  - 如果有鼠标，则将外边框颜色设置为红色并加粗，否则为黑色
  - 先调用`DrawRectangle`画外边框，再调用`DrawContent`绘制文字

##### DrawLink

- 函数原型

  ```c
  void DrawLink(Link* link);
  ```

- 功能描述：绘制链接

- 参数描述：

  - `link`：待绘制的链接

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 查看当前`link`上是否有鼠标（通过查看其`status`字段）
  - 如果有鼠标，则绘制下划线
  - 绘制文字

##### DrawLabel

- 函数原型

  ```c
  void DrawLabel(Label* label);
  ```

- 功能描述：绘制标签

- 参数描述：

  - `label`为待绘制的标签

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### DrawUIImage

- 函数原型

  ```c
  void DrawUIImage(Image* image);
  ```

- 功能描述：绘制图像

- 参数描述：

  - `image`：待绘制的图像

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### DrawFramwork

- 函数原型

  ```c
  void DrawFramwork();
  ```

- 功能描述：绘制框架（背景）

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：遍历链表，依次绘画框架

##### Inbox

- 函数原型

  ```c
  int Inbox(int x, int y, Rect* rect)
  ```

- 功能描述：检查坐标$(x, y)$在不在矩形`rect`内

- 参数描述：见上

- 返回值描述：返回0或者1

  - 0：不在
  - 1：在

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：检查这个点的x在不在矩形左右边界之间，检查这个点的y在不在矩形上下边界之间

##### DisplayAnimateComponents

- 函数原型

  ```c
  void DisplayAnimateComponents(CompList L, int x, int y)
  ```

- 功能描述：根据当前鼠标坐标$(x, y)$绘制图层`L`

- 参数描述：见上，其中由于一个图层的所有元素是用链表进行串联，所以用`L`来标识图层

- 返回值描述：无

- 重要局部变量定义

  - 一组临时的组件指针：用来转化当前遇到的元件（以`void*`形式描述）

- 重要局部变量用途描述：见上

- 函数算法描述：遍历链表，根据链表记录的元件类型依次绘制元件

##### HandleClickOnSur

- 函数原型

  ```c
  void HandleClickOnSur(int x, int y, int mouse_button, int event)
  ```

- 功能描述：处理顶层点击的回调

- 参数描述：

  - `x`：鼠标的x坐标
  - `y`：鼠标的y坐标
  - `mouse_button`：鼠标哪一个按键触发的事件
  - `event`：鼠标触发的事件

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：遍历顶层链表，判断当前点击发生在哪一个元件上然后执行对应的回调

##### HandleClickOnComp

- 函数原型

  ```c
  void HandleClickOnComp(int x, int y, int mouse_button, int event);
  ```

- 功能描述：处理元件层点击的回调

- 参数描述：

  - `x`：鼠标的x坐标
  - `y`：鼠标的y坐标
  - `mouse_button`：鼠标哪一个按键触发的事件
  - `event`：鼠标触发的事件

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：遍历元件层链表，判断当前点击发生在哪一个元件上然后执行对应的回调

##### MoveFocus

- 函数原型

  ```c
  void MoveFocus();
  ```

- 功能描述：移动焦点（按下tab键的情景）

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：将全局变量`focus`（元件层上一个指向链表节点的元素）变为其指向的下一个元素，跳过其中所有`Label`元件）

##### MoveCursor

- 函数原型

  ```c
  void MoveCursor(int delta);
  ```

- 功能描述：移动当前输入框的光标

- 参数描述：

  - `delta`：只可能是1/-1/1000/-1000的其中一个，分别表示向前移动、向后移动、向前到底、向后倒底

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：

  - 首先进行越界检查，如果该操作导致越位，那就移动到开头或者结尾
  - 判断当前字符是不是中文，视情况进行移动一步或者两步

##### InsertChar

- 函数原型

  ```c
  void InsertChar(char* str, char ch, int position);
  ```

- 功能描述：在字符串`str`的`position`位之前插入字符`ch`

- 参数描述：见上

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：找到对应位置，将后面的元素向后移动一位，插入该字符

##### DeleteChar

- 函数原型

  ```c
  void DeleteChar(char* str, int position);
  ```

- 功能描述：删除字符串`str`的第`position`位

- 参数描述：见上

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：找到对应位置，判断是否是中文字符，视情况将其后的位置向前移动一位或两位

##### ChangeInputBox

- 函数原型

  ```c
  void ChangeInputBox(int key);
  ```

- 功能描述：当键盘输入字符为`key`值（使用`int`是为了扩充可处理的字符集）的时候，改变当前输入框的内容

- 参数描述：见上

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：先判断当前焦点是否是输入框，如果是，则调用`InsertChar`函数

##### DeleteInputBox

- 函数原型

  ```c
  void DeleteInputBox();
  ```

- 功能描述：删除当前的输入框光标后的字符

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：无

##### BackSpaceInputBox

- 函数原型

  ```c
  void BackSpaceInputBox();
  ```

- 功能描述：删除当前的输入框光标前的字符

- 参数描述：无

- 返回值描述：无

- 重要局部变量定义：无

- 重要局部变量用途描述：无

- 函数算法描述：如果合法，先将光标向前移动，后调用`DeleteInputBox`

### view

#### main.c

##### Main

* 函数原型
  ```c
  void Main();
  ```

* 功能描述
* 参数描述
* 返回值描述
* 重要局部变量定义
* 重要局部变量用途描述
* 函数算法描述

# 4 部署运行和使用说明

## 4.1 编译安装

## 4.2 运行测试

## 4.3 使用操作

# 5 团队合作

## 5.1 任务分工

（略）

## 5.2 开发计划

| 日期        | 工作                 |
| ----------- | -------------------- |
| 4.21 - 4.27 | 大程开始，敲定选题   |
| 4.28 - 5.3  | 分工，完成头文件编写 |
| 5.4 - 5.12  | 同步开发             |
| 5.12 - 5.18 | 整合、调试、编写文档 |

## 5.3 编码规范

文件统一采用UTF-8编码，CRLF换行

代码风格采用谷歌的[C++ 风格指南](https://zh-google-styleguide.readthedocs.io/en/latest/google-cpp-styleguide/contents/)（删去其中C++特性的部分）

## 5.4 合作总结

## 5.5 收获感言

# 6 参考文献资料

1. [SHA256](https://en.wikipedia.org/wiki/SHA-2)